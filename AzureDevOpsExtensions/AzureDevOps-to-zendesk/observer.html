<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AzureDevOps to Zendesk Extension</title>
</head>

<body>
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>

    <script>

        let abraKadaBra = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa";
        let azureProjectItems = "https://aonanalytics.visualstudio.com/WorkflowStudio/_workitems/edit/";
        let linkCountOld;
        let stateOld;
        let zdTicketOld;
        let zendeskSpace = "https://and.zendesk.com";

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        
        // Get data service
        VSS.getService(VSS.ServiceIds.ExtensionData).then(function (dataService) {
            // Set value in user scope of the VSS-starage
            dataService.setValue("userScopedKey", 1234567, { scopeType: "User" }).then(function (value) {
                console.log("User scoped key value is " + value);
            });

            // Get value in user scope of the VSS-starage
            dataService.getValue("userScopedKey", { scopeType: "User" }).then(function (value) {
                console.log("User scoped key value is " + value);
            });
        });


        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService - to GET/SET FIELDS/LINKS for the currently is displayed Work item.

            function getWorkItemFormService() {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            function sendUpdatesToZendesk(zdIdToInform, comments) {

                if (comments != "") { // We have some updates to send to ZD.

                    let http_request2 = new XMLHttpRequest();

                    let commentData = {
                        ticket: {
                            comment: {
                                author_id: 368907442298,
                                body: comments,
                                public: false
                            }
                        }
                    };

                    let json = JSON.stringify(commentData);

                    http_request2.open("PUT", `${zendeskSpace}/api/v2/tickets/${zdIdToInform}.json`, true);

                    http_request2.setRequestHeader("Content-type", "application/json;charset=utf-8");

                    http_request2.setRequestHeader("Authorization", "Bearer " + abraKadaBra);

                    http_request2.onload = function () {
                        var response = JSON.parse(http_request2.responseText);
                        if (http_request2.readyState == 4 && http_request2.status == "200") {
                            console.log(response);
                        } else {
                            console.error(response);
                        }
                    }

                    http_request2.send(json);

                    console.log('XMLHttpRequest must be already sent.');
                }
            }

            // Register a LISTENER for the work item GROUP contribution.

            VSS.register(VSS.getContribution().id, function () {
                return {

                    // Called when a new work item is being loaded in the UI
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["Custom.ZendeskTicket#", "System.State", "System.RelatedLinkCount"]).then(
                                function (value) {
                                    linkCountOld = value["System.RelatedLinkCount"];
                                    stateOld = value["System.State"];
                                    zdTicketOld = value["Custom.ZendeskTicket#"];
                                }
                            )
                        });
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {
                        getWorkItemFormService().then(function (service) {

                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.Id", "Custom.ZendeskTicket#", "System.State", "System.RelatedLinkCount"]).then(

                                function (value) {

                                    let workitemID = value["System.Id"];



                                    // T E M P O R A R Y   T E S T I N G !!!



                                    if (workitemID != 22177) {
                                        // ONLY TESTING WORK-ITEM - SKIP OTHERS !
                                    }
                                    else {
                                        let linkCountNew;
                                        let stateNew;
                                        let updatesComment = "";
                                        let zdTicketNew = value["Custom.ZendeskTicket#"];

                                        let azureWorkItemLink = `[Azure DevOps WorkItem ${workitemID}](${azureProjectItems}${workitemID})`;

                                        // Link to Zendesk has Changed !
                                        if (zdTicketOld != zdTicketNew) {

                                            if (zdTicketNew != 'undefined') {
                                                updatesComment = azureWorkItemLink +
                                                    ` has been Bound to this ticket! All important this work item's changes will be posted here.`;

                                                sendUpdatesToZendesk(zdTicketNew, updatesComment);
                                            }

                                            if (zdTicketOld != 'undefined') {
                                                updatesComment = azureWorkItemLink +
                                                    ` has been Unbound from this ticket! No any this work item's events will be posted here any more.`;

                                                sendUpdatesToZendesk(zdTicketOld, updatesComment);
                                            }

                                            // Update Global Var for the next updates on this page :
                                            zdTicketOld = zdTicketNew;
                                        }
                                        else if (zdTicketNew != 'undefined') {

                                            // SEND UPDATES INFO :

                                            stateNew = value["System.State"];
                                            linkCountNew = value["System.RelatedLinkCount"];

                                            if (stateOld != stateNew) {
                                                updatesComment += `\n\n State of the bound ${azureWorkItemLink} is changed from "${stateOld}" to "${stateNew}"`;
                                                // Update Global Var for the next updates on this page :
                                                stateOld = stateNew;
                                            }
                                            if (linkCountOld != linkCountNew) {
                                                updatesComment += `\n\n RelatedLinkCount of the bound ${azureWorkItemLink} is changed from "${linkCountOld}" to "${linkCountNew}"`;
                                                // Update Global Var for the next updates on this page :
                                                linkCountOld = linkCountNew;
                                            }

                                            sendUpdatesToZendesk(zdTicketNew, updatesComment);
                                        }
                                    }
                                }
                            );
                        });
                    }
                };
            });

            VSS.notifyLoadSucceeded();

        });

    </script>
</body>

</html>