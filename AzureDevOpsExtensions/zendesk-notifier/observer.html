<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
</head>

<body>
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>

    <script>

        let linkCountAfter;
        let linkCountBefore;
        let stateAfter;
        let stateBefore;
        let updatesComment = "";

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService - to GET/SET FIELDS/LINKS for the currently is displayed Work item.

            function getWorkItemFormService() {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            // Register a LISTENER for the work item GROUP contribution.

            VSS.register(VSS.getContribution().id, function () {
                return {


                    // Called when a new work item is being loaded in the UI
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State", "System.RelatedLinkCount"]).then(
                                function (value) {
                                    stateBefore = value["System.State"];
                                    linkCountBefore = value["System.RelatedLinkCount"];
                                }
                            )
                        });
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State", "System.RelatedLinkCount"]).then(

                                function (value) {

                                    stateAfter = value["System.State"];
                                    linkCountAfter = value["System.RelatedLinkCount"];

                                    updatesComment += (stateAfter == stateBefore ? "" : `\n - State is updated to ${stateAfter}`);
                                    updatesComment += (linkCountAfter == linkCountBefore ? "" : `\n - RelatedLinkCount incremented till ${linkCountAfter}`);

                                    // We have some updates => should be sent to ZD.
                                    if (updatesComment != "") {

                                        let http_request = new XMLHttpRequest();

                                        let _WARNING_WARNING_ = "_WARNING_WARNING_!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!";

                                        let commentData = {
                                            ticket: {
                                                comment: {
                                                    author_id: 368907442298,
                                                    body: updatesComment,
                                                    public: false
                                                }
                                            }
                                        };

                                        let json = JSON.stringify(commentData);

                                        // http_request.open("POST", "https://hookb.in/JKQR6XJpxViwjyQNlWNx");
                                        // http_request.send('{"name": "' + args['id'] + ' is now ' + newStateValue + '"}');

                                        http_request.open("PUT", "https://and.zendesk.com/api/v2/tickets/3.json", true); // var TICKET_ID !

                                        http_request.setRequestHeader("Content-type", "application/json;charset=utf-8");

                                        http_request.setRequestHeader("Authorization", "Bearer " + _WARNING_WARNING_);

                                        http_request.onload = function () {
                                            var response = JSON.parse(http_request.responseText);
                                            if (http_request.readyState == 4 && http_request.status == "200") {
                                                console.log(response);
                                            } else {
                                                console.error(response);
                                            }
                                        }

                                        http_request.send(json);

                                        updatesComment = "";

                                        console.log('AAA - XMLHttpRequest must be already sent.');
                                    }
                                }
                            )
                        });
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</body>

</html>