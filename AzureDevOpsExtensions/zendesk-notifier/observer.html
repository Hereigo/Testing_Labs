<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
</head>

<body>
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>

    <script>

        let startedWorkItemState;
        let newStateValue;

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService - to GET/SET FIELDS/LINKS for the currently is displayed Work item.

            function getWorkItemFormService() {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            // Register a LISTENER for the work item GROUP contribution.

            VSS.register(VSS.getContribution().id, function () {
                return {


                    // Called when a new work item is being loaded in the UI
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State"]).then(
                                function (value) {
                                    startedWorkItemState = value["System.State"];
                                }
                            )
                        });
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State"]).then(
                                function (value) {

                                    newStateValue = value["System.State"];

                                    if (newStateValue != startedWorkItemState) {

                                        let http_request = new XMLHttpRequest();
                                        http_request.open("POST", "https://hookb.in/JKQR6XJpxViwjyQNlWNx");
                                        //http_request.withCredentials = true;
                                        http_request.setRequestHeader("Content-Type", "application/json");
                                        http_request.send('{"name": "' + args['id'] + ' is now ' + newStateValue + '"}');

                                        console.log('AAA - XMLHttpRequest must be already sent.');
                                    }
                                }
                            )
                        });
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</body>

</html>