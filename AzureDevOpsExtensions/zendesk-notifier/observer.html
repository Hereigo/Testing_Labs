<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
</head>

<body>
    <script src="node_modules/vss-web-extension-sdk/lib/VSS.SDK.min.js"></script>

    <script>

        let startedWorkItemState;
        let newStateValue;

        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true
        });

        VSS.require(["TFS/WorkItemTracking/Services"], function (_WorkItemServices) {

            // Get the WorkItemFormService - to GET/SET FIELDS/LINKS for the currently is displayed Work item.

            function getWorkItemFormService() {
                return _WorkItemServices.WorkItemFormService.getService();
            }

            // Register a LISTENER for the work item GROUP contribution.

            VSS.register(VSS.getContribution().id, function () {
                return {


                    // Called when a new work item is being loaded in the UI
                    onLoaded: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State"]).then(
                                function (value) {
                                    startedWorkItemState = value["System.State"];
                                }
                            )
                        });
                    },

                    // Called after the work item has been saved
                    onSaved: function (args) {

                        getWorkItemFormService().then(function (service) {
                            // Get the current values for a few of the common fields

                            service.getFieldValues(["System.State"]).then(

                                function (value) {

                                    newStateValue = value["System.State"];

                                    if (newStateValue != startedWorkItemState) {

                                        let http_request = new XMLHttpRequest();

                                        let _WARNING_WARNING_ = "";

                                        let commentData = {
                                            ticket: {
                                                comment: {
                                                    author_id: 368907442298,
                                                    body: "One another private comment from azurus of 23-12 15:50 :)",
                                                    public: false
                                                }
                                            }
                                        };

                                        let json = JSON.stringify(commentData);

                                        // http_request.open("POST", "https://hookb.in/JKQR6XJpxViwjyQNlWNx");
                                        // http_request.send('{"name": "' + args['id'] + ' is now ' + newStateValue + '"}');

                                        http_request.open("PUT", "https://and.zendesk.com/api/v2/tickets/3.json", true); // var TICKET_ID !

                                        http_request.setRequestHeader("Content-type", "application/json;charset=utf-8");

                                        http_request.setRequestHeader("Authorization", "Bearer " + _WARNING_WARNING_);

                                        http_request.onload = function () {
                                            var response = JSON.parse(http_request.responseText);
                                            if (http_request.readyState == 4 && http_request.status == "200") {
                                                console.log(response);
                                            } else {
                                                console.error(response);
                                            }
                                        }

                                        http_request.send(json);

                                        console.log('AAA - XMLHttpRequest must be already sent.');
                                    }
                                }
                            )
                        });
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });
    </script>
</body>

</html>